/*
EntityJS Javascript Game Engine
Copyright 2011, Ben D'Angelo 
http://entityjs.com

Licensed under MIT http://entityjs.com/license

*/
re=function(a){return new re.query(a)},re.version="0.3.0",re._e=[],re._c={},re.ready=function(a){re.ready.c.push(a),window.onload=function(){for(var a in re.ready.c)re.ready.c[a].call(re)}},re.ready.c=[],re.$=function(a){return re.$.c[a]=re.$.c[a]||(a.charAt(0)=="#"?document.getElementById(a.substr(1)):document.getElementsByTagName(a)[0])},re.$.c={},re.$new=function(a){return document.createElement(a)},re.listener=function(a,b){window.addEventListener?window.addEventListener(a,b,!0):document.attachEvent("on"+a,b)},re.is=function(a,b){return arguments.length==1?a!=null:a!=null&&Object.prototype.toString.call(a).slice(8,-1).toLowerCase()==b.toLowerCase()},Array.prototype.indexOf||(Array.prototype.indexOf=function(a){for(var b=0;b<this.length;b++)if(this[b]==a)return b;return-1});var __z=function(a,b){return this._checkFinal(),this[a]||(this[a]=[]),re.is(b,"string")?this[a]=this[a].concat(b.split(" ")):this[a]=this[a].concat(b),this};re.comp=re.c=function(a){return re._c[a]||(re._c[a]=new re.c.init(a)),re._c[a]},re.c.init=function(a){this.name=a,this._re_signals={},this._re_inherits={},this._re_defines={},this._re_final=!1},re.c.init.prototype={_checkFinal:function(){if(this._re_final)throw this.name+" is final."},global:function(){throw"Deprecated use statics"},statics:function(a,b){this._checkFinal();if(arguments.length==1)for(var c in a)this[c]=a[c];else this[a]=b;return this},require:function(){throw"Deprecated use requires"},requires:function(a){return __z.call(this,"_re_requires",a)},asserts:function(a){return __z.call(this,"_re_asserts",a)},interfaces:function(a){return __z.call(this,"_re_implements",a)},alias:function(a){this._checkFinal();var b=a.split(" ");if(b.length>1){for(var c in b)this.alias(b[c]);return this}return a.charAt(0)=="-"?re._c[a.substr(1)]==this&&delete re._c[a.substr(1)]:re._c[a]=this,this},on:function(){return re.e.init.prototype.on.apply(this,arguments)},off:function(){return re.e.init.prototype.off.apply(this,arguments)},trigger:function(){return re.e.init.prototype.trigger.apply(this,arguments)},inherit:function(){throw"Deprecated use defaults"},defaults:function(a,b){this._checkFinal();if(arguments.length==1)for(var c in a)this._re_inherits[c]=a[c];else this._re_inherits[a]=b;return this},namespaces:function(a,b){this._checkFinal();var c=this.name+"_";if(arguments.length==1)for(var d in a)this._re_defines[c+d]=a[d];else this._re_defines[c+a]=b;return this},extend:function(){this.defines.apply(this,arguments),re.log("warning extend is deprecated, use defines")},defines:function(a,b){this._checkFinal();if(arguments.length==1)for(var c in a)this._re_defines[c]=a[c];else this._re_defines[a]=b;return this},init:function(a){return this._checkFinal(),this._re_init=a,this},dispose:function(a){return this._checkFinal(),this._re_dispose=a,this},lock:function(){return this._checkFinal(),this._re_final=!0,this},run:function(a){return this._checkFinal(),a.call(this),this}},function(a){var b=function(b,c){if(!c)return new a.entity.init(b);var d=a();for(var e=0;e<c;e++)d.push(a.e(b));return d};b.id=0;var c=function(c){this._re_comps=[],this._re_signals={},this.id=b.id+"",b.id++,a._e.push(this),this.comp(c)},d=c.prototype;d.id="",d.addComp=function(b){a.log("AddComp deprecated use comp"),this.comp(b)},d.comp=function(a){this._re_comp(a);if(this._re_implements)for(var b in this._re_implements)if(!this.hasOwnProperty(this._re_implements[b]))throw"interface: "+this._re_implements[b]+" missing";if(this._re_asserts)for(var c in this._re_asserts)if(this._re_comps.indexOf(this._re_asserts[c])!=-1)throw"assert: "+this._re_asserts[c]+" is not allowed";return this},d.removeComp=function(b){var c;a.is(b,"array")?(c=b,b=b[0]):c=b.split(" ");if(c.length>1){for(var d in c)this._re_comp(c[d]);return this}var e=a._c[b];if(!this.has(b))return this;this._re_comps.splice(this._re_comps.indexOf(b),1),e&&(e._re_dispose&&e._re_dispose.call(this,e),e.trigger("dispose",this))},d._re_comp=function(b){if(!b)return this;var c;a.is(b,"array")?(c=b,b=b[0]):c=b.split(" ");if(c.length>1){for(var d in c)this._re_comp(c[d]);return this}var e,f=b.split(":");return b=f[0],e=a._c[b],f[0]=e,this.has(b)?this:(this._re_comps.push(b),e&&(this._re_comp(e._re_requires),e._re_implements&&(this._re_implements||(this._re_implements=[]),this._re_implements=this._re_implements.concat(e._re_implements)),e._re_asserts&&(this._re_asserts||(this._re_asserts=[]),this._re_asserts=this._re_asserts.concat(e._re_asserts)),e._re_inherits&&this.def(e._re_inherits),e._re_defines&&this.attr(e._re_defines),e._re_init&&e._re_init.apply(this,f),e.trigger("init",this)),this)},d.comps=function(){return this._re_comps.slice()},d.clone=function(b){return a.e(this._re_comps,b)},d.parent=function(b,c){var d=Array.prototype.slice.call(arguments,2);if(b=="")return a.e.init.prototype[c].apply(this,d);var e=a._c[b];return e._re_defines[c]?e._re_defines[c].apply(this,d):e._re_inherits[c].apply(this,d)},d.has=function(b){a.is(b,"string")&&(b=a.query._toObj(b)),b.comp=b.comp||[],b.id=b.id||"",b.on=b.on||[],b.not=b.not||[];for(d=0;d<b.comp.length;d++)if(this._re_comps.indexOf(b.comp[d])==-1)return!1;for(d=0;d<b.not.length;d++)if(this._re_comps.indexOf(b.not[d])!=-1)return!1;var c;for(d=0;d<b.on.length;d++){c=b.on[d];if(!this._re_signals[c]||this._re_signals[c].length==0)return!1}return b.id!=""&&this.id!=b.id?!1:!0},d.on=function(b,c){if(a.is(b,"object"))for(var d in b)this.on(d,b[d]);else{this._re_signals[b]||(this._re_signals[b]=[]);if(!a.is(c))throw"Method is null";this._re_signals[b].push(c)}return this},d.off=function(b,c){if(a.is(b,"object"))for(var d in b)this.off(d,b[d]);else if(c)for(var d in this._re_signals[b])this._re_signals[b][d]==c&&this._re_signals[b].splice(d,1);else b?this._re_signals[b]=[]:this._re_signals={};return this},d.trigger=function(a){if(!this._re_signals[a])return this;var b;for(var c=0,d=this._re_signals[a].length;c<d;c++){b=this._re_signals[a];if(!b[c])continue;b[c].apply(b[c].c?b[c].c:this,Array.prototype.slice.call(arguments,1))===!1&&b.splice(c,1)}return this},d.extend=function(){throw"Deprecated use attr"},d.attr=function(b,c){if(a.is(b,"object"))for(var d in b){if(!b.hasOwnProperty(d))continue;this.attr(d,b[d])}else a.is(this[b],"function")&&!a.is(c,"function")?a.is(c,"array")?this[b].apply(this,c):this[b].call(this,c):this[b]=c;return this},d.inherit=function(){throw"Deprecated use def"},d.defaults=function(){throw"Deprecated use def"},d.def=function(b,c){if(a.is(b,"object"))for(var d in b){if(!b.hasOwnProperty(d))continue;this.def(d,b[d])}else if(!this.hasOwnProperty(b)||!a.is(this[b]))this[b]=c;return this},d.dispose=function(){a._e.splice(a._e.indexOf(this),1);for(var b in this._re_comps){var c=a.c(this._re_comps[b]);c._re_dispose&&c._re_dispose.call(this,c),c.trigger("dispose",this)}return this.trigger("dispose"),this},a.entity=a.e=b,a.entity.init=c}(re),function(a){var b=function(b){return new a.load.init(b)};b.path="",b.imageExt="img",b.soundExt="sfx",b.images=["gif","jpg","jpeg","png"],b.sounds=["wav","mp3","aac","ogg"];var c=function(b){if(a.is(b,"string"))this.assets=b.split(" ");else if(a.is(b,"object")){this.assets=[];for(var c in b)b.hasOwnProperty(c)&&a.is(b[c],"array")&&(this.assets=this.assets.concat(b[c]))}else this.assets=b;var d;for(var c=0;c<this.assets.length;c++){this.total++,d=this.assets[c];var e=d.lastIndexOf(".")+1,f=d.substr(e).toLowerCase(),g=d,h=d.lastIndexOf("/");h!=-1&&(d=d.substr(h+1,d.length));var i=d.substr(0,e);if(a.load.images.indexOf(f)!=-1)this._loadImg(g,d,i);else if(a.load.sounds.indexOf(f)!=-1){if(!!a.support&&!a.support(f))throw"Browser doesn't support audio codec "+f;this._loadSound(g,d,i)}}return this},d=c.prototype;d.current=0,d.total=0,d._loadImg=function(b,c,d){var e=this,f=new Image;return a.c(c).alias(d+a.load.imageExt).statics({image:f}).defines({_image:f}),f.onload=function(){a.c(c).defaults({sizeX:f.width,sizeY:f.height}).defines("bisect",f.width),e._loaded()},f.onerror=function(){e._e&&e._e.call(e,c)},f.src=a.load.path+b,this},d._loaded=function(){this.current++,this.current<=this.total&&this._p&&this._p(this.current,this.total,this.assets[this.current-1]),this.current==this.total&&this._s&&this._s(this.assets)},d._loadSound=function(b,c,d){var e=this,f=new Audio(a.load.path+b);f.src=a.load.path+b,f.preload="auto",f.load(),a.c(c).alias(d+a.load.soundExt).statics({sound:f}).defines({_sound:f});var g=function(){e._loaded(),f.removeEventListener("canplaythrough",g)};f.addEventListener("canplaythrough",g,!1),f.addEventListener("error",function(){e._e&&e._e.call(e,c)},!1)},d.progress=function(a){return this._p=a,this},d.complete=function(a){return this._s=a,this.assets.length==0&&a([]),this},d.error=function(a){return this._e=a,this},a.load=b,a.load.init=c}(re),function(a){var b=function(a){a&&this.query(a)};b._toObj=function(a){if(b.c[a])return b.c[a];var c=a.split(" "),d=[],e=[],f=[],g="",h,i;for(var j=c.length;j--;)h=c[j].charAt(0),i=c[j].substr(1),h=="^"?e.push(i):h=="!"?f.push(i):h=="#"?g=i:d.push(c[j]);var k={comp:d,on:e,not:f,id:g};return b.c[a]=k,k},b.c={};var c=b.prototype=new Array;c.query=function(c){c=c||"";var d=a._e.length,e=-1,f;if(a.is(c,"string")){if(c=="*")return this.push.apply(this,a._e.slice()),this;var g=b._toObj(c);while(++e<d&&(f=a._e[e]))f.has(g)&&this.push(f)}else if(a.is(c,"function"))while(++e<d&&(f=a._e[e]))c.call(f,e,d)&&this.push(f);return this},c.method=function(a){var b=Array.prototype.slice.call(arguments,1);return this.each(function(){this[a].apply(this,b)})},c.each=function(a){var b=this.length,c=-1,d;while(++c<b&&(d=this[c])&&a.call(d,c,b)!==!1);return this},c.tilemap=function(a,b){var c=0,d=0;return this.each(function(e,f){if(b.call(this[e],c,d,e,f)==0)return!1;c++,c==a&&(c=0,d++)})},c.comps=function(){var a=[];return this.each(function(){var b=this.comps();for(var c=0;c<b.length;c++)a.indexOf(b[c])==-1&&a.push(b[c])}),a},c.random=function(){return this[~~(Math.random()*this.length)]},c.pluck=function(a){var b=[],c=a.split(" ");return this.each(function(){var a={};for(var d in c)c.hasOwnProperty(d)&&(a[c[d]]=this[c[d]]);b.push(a)}),b},c.defines=function(){throw"Deprecated use attr"},c.attr=function(a,b){return this.each(function(){this.attr(a,b)})},c.defaults=function(){throw"Deprecated use def"},c.def=function(a,b){return this.each(function(){this.def(a,b)})},c.comp=function(a){return this.each(function(b){this.comp(a)})},c.removeComp=function(a){return this.each(function(b){this.removeComp(a)})},c.on=function(a,b){return this.each(function(){this.on(a,b)})},c.off=function(a,b){return this.each(function(){this.off(a,b)})},c.trigger=function(){var a=arguments;return this.each(function(){this.trigger.apply(this,a)})},c.has=function(a){for(var b=0;b<this.length;b++)if(!this[b].has(a))return!1;return this.length!=0},c.dispose=function(){return this.each(function(){this.dispose()})},a.query=b}(re),re.c("system").defaults({clearColor:"#f9f9f9",stepSize:.03,maxTick:.05,running:!1,sizeX:10,sizeY:10}).defines({clear:function(a){return a?(this.context.fillStyle=a,this.context.fillRect(0,0,this.sizeX,this.sizeY)):this.context.clearRect(0,0,this.sizeX,this.sizeY),this},start:function(){if(!this.running){this.running=!0;var a=this;(function b(){a.system_loop(),a.running&&a.requestAnimationFrame(b,a.canvas)})()}return this},loop:function(a){return this.system_loop=a,this},stop:function(){return this.running=!1,this},init:function(a,b,c){re._c.keyboard&&re._c.keyboard.i(),re._c.mouse&&re._c.mouse.i(),re._c.touch&&re._c.touch.i(),this.comp("polyfill tick timestep"),this.canvas=re.$(a),this.scale=b||1,this.context=this.canvas.getContext(c||"2d");var d=re.screen=re.e("screen");return this.sizeX=d.sizeX=this.canvas.width,this.sizeY=d.sizeY=this.canvas.height,this},system_loop:function(){this.timestep(Math.min(this.tick()/1e3,this.maxTick),function(){re._c.update.update(this.stepSize)}),this.clear(this.clearColor),re._c.draw.draw(this.context)}}).run(function(){re.system=re.sys=re.e("system")}),re.c("draw").statics({l:[],draw:function(a){var b=this.l;for(var c=0,d;c<b.length;c++)d=b[c],d.drawable&&d.visible()&&d.draw_render(a)}}).interfaces("draw").init(function(a){a.l.push(this)}).dispose(function(a){a.l.splice(a.l.indexOf(this),1)}).defaults({drawable:!0,rotation:0,alpha:1,scaleX:1,scaleY:1,posX:0,posY:0,sizeX:10,sizeY:10,regX:0,regY:0}).defines({cache:function(){if(!this.image)return this;this.clearCache();var a=re.$new("canvas"),b=Math.max(this.image.width,this.image.height);return a.width=b,a.height=b,this.draw_render(a.getContext(re.sys.contextType)),this.canvasCache=a,this},clearCache:function(){this.canvasCache=null},drawFirst:function(){var a=re.c("draw").l;return a.splice(a.indexOf(this),1),a.unshift(this),this},drawLast:function(){var a=re.c("draw").l;return a.splice(a.indexOf(this),1),a.push(this),this},drawAfter:function(a){var b=re.c("draw").l,c=b.indexOf(a),d=b.indexOf(this);if(c>d){var e=b[c];b[c]=b[d],b[d]=e}return this},drawBefore:function(a){var b=re.c("draw").l,c=b.indexOf(a),d=b.indexOf(this);if(c<d){var e=b[c];b[c]=b[d],b[d]=e}return this},screenX:function(a){return a?(this.posX=a+re.screen.posX,this):this.posX-re.screen.posX},screenY:function(a){return a?(this.posY=a+re.screen.posY,this):this.posY-re.screen.posY},visible:function(){return re.screen.hit(this.posX-this.regX,this.posY-this.regY,this.sizeX,this.sizeY)}}).namespaces({render:function(a){this.draw_before(a),this.draw(a),this.draw_after(a)},before:function(a){a.save(),this.alpha!=1&&(a.staticsAlpha=this.alpha),a.translate(this.screenX(),this.screenY()),this.rotation!=0&&a.rotate(this.rotation*Math.PI/180),(this.scaleX!=1||this.scaleY!=1)&&a.scale(this.scaleX,this.scaleY)},after:function(a){a.restore()}}),re.c("tick").init(function(){this.lastTime=Date.now()}).defines({tick:function(){var a=Date.now(),b=this.lastTime;return this.lastTime=a,a-b}}),re.c("tween").requires("update").statics({tween:function(a,b,c){return a.comp("tween").tween(b,c)}}).namespaces({update:function(a){}}).defaults({tweening:!1}).defines({tween:function(a,b){this.time=a||5,this.tweening&&this.unbind("update",this.tween_update);for(var c in b){if(!b.hasOwnProperty(c))continue;this.tween_props[c]={s:re.sys.stepSize,i:b[c]}}return this}}).init(function(){this.tween_props={}}),re.tween=re.c("tween").tween,re.c("update").statics({l:[],update:function(a){var b=this.l;for(var c=0,d;c<b.length;c++)d=b[c],d.updatable&&d.trigger("update",a)}}).defaults({updatable:!0}).defines(function(){var a=re.c("update").l;return{updateFirst:function(){return a.splice(a.indexOf(this),1),a.unshift(this),this},updateLast:function(){return a.splice(a.indexOf(this),1),a.push(this),this},updateAfter:function(b){var c=a.indexOf(b),d=a.indexOf(this);if(c>d){var e=a[c];a[c]=a[d],a[d]=e}return this},updateBefore:function(b){var c=a.indexOf(b),d=a.indexOf(this);if(c<d){var e=a[c];a[c]=a[d],a[d]=e}return this}}}()).init(function(a){a.l.push(this)}).dispose(function(a){a.l.splice(a.l.indexOf(this),1)}),re.c("wait").requires("update").defines({wait:function(a,b){var c=0;return this.bind("update",function(b){c+=b;if(c>=a)return this.callback.apply(this,Array.prototype.slice.call(arguments,2)),!1}),this}}),re.c("align").requires("draw").defines({alignHor:function(a){return a=a||0,this.posX=re.sys.sizeX*.5-(this.sizeX+this.regX)*.5+a|0,this},alignVer:function(a){return a=a||0,this.posY=re.sys.sizeY*.5-(this.sizeY+this.regY)*.5+a|0,this},alignRight:function(a){return a=a||0,this.posX=re.sys.sizeX-(this.sizeX+this.regX)+a|0,this},alignLeft:function(a){return a=a||0,this.posX=a+this.sizeX-(this.sizeX+this.regX)|0,this},alignTop:function(a){return a=a||0,this.posY=a+this.sizeY-(this.sizeY+this.regY)|0,this},alignBottom:function(a){return a=a||0,this.posY=re.sys.sizeY-(this.sizeY+this.regY)+a|0,this}}),re.c("circle").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(a){return a.fillStyle=this.color,a.beginPath(),a.arc(-this.regX+this.sizeX*.5,-this.regY+this.sizeX*.5,this.sizeX,0,Math.PI*2,!0),a.closePath(),a.fill(),this},radius:function(a){return re.is(a)?(this.sizeX=this.sizeY=a,this):this.sizeX}}),re.c("group").defaults({posX:0,posY:0}).defines({group:function(){for(var a=0;a<arguments.length;a++)arguments[a].comp("group").group},ungroup:function(a){},getScreenX:function(){var a=this.posX;return this.group&&(a+=this.group.posX),this.screen&&(a+=this.screen.posX),a},getScreenY:function(){var a=this.posY;return this.group&&(a+=this.group.posY),this.screen&&(a+=this.screen.posY),a},getGroupX:function(){var a=this.posX;return this.group&&(a+=this.group.posX),a},getGroupY:function(){var a=this.posY;return this.group&&(a+=this.group.posY),a},setGroupX:function(a){},setGroupY:function(a){}}),re.c("image").requires("draw").defines({image:function(a){return re.is(a)?(this.attr({_image:a,sizeX:a.width,sizeY:a.height}),this):this._image},visible:function(){return this._image&&this.parent("draw","visible")},draw:function(a){return a.drawImage(this._image,-this.regX,-this.regY,this.sizeX,this.sizeY),this}}).init(function(){this._image&&this.image(this._image)}),re.c("imgtext").requires("draw").interfaces("imgtext").defaults({charOffset:32}).defines({visible:function(){return this._text&&this._image&&this.parent("draw","visible")},draw:function(a){var b=0,c,d,e;for(var f=0,g=this._text.length;f<g;++f){d=this._text.charCodeAt(f)-this.charOffset,c=this.imgtext[d];if(!this.charCache[d]){e=0;for(var h=0;h<d;++h)e+=this.imgtext[h]+1;this.charCache[d]=e}a.drawImage(this._image,this.charCache[d],0,c,this._image.height,-this.regX+b,-this.regY,c,this._image.height),b+=c}return this.sizeX=b,this.sizeY=this._image.height,this},text:function(a){if(re.is(a)){this._text=a;var a=0;for(var b=0;b<this._text.length;b++)a+=this.imgtext[b];return this.sizeX=a,this._image?this.sizeY=this._image.height:this.sizeY=0,this}return this._text}}).init(function(){this.charCache||(this.charCache={}),this.text("")}),re.c("rect").requires("draw").defaults({color:"#82d5f4"}).defines({draw:function(a){return a.fillStyle=this.color,a.fillRect(-this.regX,-this.regY,this.sizeX,this.sizeY),this}}),re.c("screen").requires("hit").defines({pos:function(a,b){return arguments.length?(arguments.length==1&&(b=a.posY,a=a.posX),this.posX=a-this.regX,this.posY=b-this.regY,this):this},toScreenX:function(a){return a+this.posX+this.offX},toScreenY:function(a){return a+this.posY+this.offY},toScreen:function(a,b){return arguments.length==1&&(b=a.posY||a.y,a=a.posX||a.x),{x:this.toScreenX(a),y:this.toScreenY(b)}}}).defaults({posX:0,posY:0,regX:0,regY:0,sizeX:0,sizeY:0,offX:0,offY:0}),re.c("sprite").requires("image bisect").defaults({frameX:0,frameY:0}).defines({frame:function(a){return re.is(a)?(this.frameX=this.biToTileX(a),this.frameY=this.biToTileY(a),this):this.tileToBi(this.frameX,this.frameY)},draw:function(a){return a.drawImage(this._image,this.frameX*this.sizeX,this.frameY*this.sizeY,this.sizeX,this.sizeY,-this.regX,-this.regY,this.sizeX,this.sizeY),this},flick:function(a){this.frame(a)}}),re.c("text").requires("draw").defaults({font:"14px sans-serif",textColor:"#000000",textAlign:"",font_text:""}).defines({visible:function(){return this._text&&this.parent("draw","visible")},text:function(a){return re.is(a)?(this._text=a,this):this._text},draw:function(a){return a.font=this.font,a.fillStyle=this.textColor,a.fillText(this._text,-this.regX,-this.regY),this}}),re.c("keyboard").statics({l:[],keyCodes:{65:"a",66:"b",67:"c",68:"d",69:"e",70:"f",71:"g",72:"h",73:"i",74:"j",75:"k",76:"l",77:"m",78:"n",79:"o",80:"p",81:"q",82:"r",83:"s",84:"t",85:"u",86:"v",87:"w",88:"x",89:"y",90:"z",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",16:"shift",17:"ctrl",18:"alt",24:"cmd",255:"fn",8:"backspace",13:"enter",32:"space",27:"esc",9:"tab",20:"capslock",91:"windows",46:"delete",36:"home",35:"end",33:"pageup",34:"pagedown",37:"left",38:"up",39:"right",40:"down",96:"`",45:"-",187:"=",219:"[",221:"]",220:"\\",59:";",222:"'",188:",",190:".",191:"/"},event:function(a){var b=re._c.keyboard;if(b.body!=document.activeElement)return;var c=a.keyCode||a.which,d=b.keyCodes[c];re.pressed.d&&(re.pressed.d[d]=a.type=="keydown");for(var e=0;e<b.l.length;e++)b.l[e].trigger(a.type,d,a).trigger(a.type+":"+d,d,a)},i:function(){this.body=re.$("body"),re.listener("keydown",this.event,!1),re.listener("keyup",this.event,!1)}}).init(function(a){a.l.push(this)}).dispose(function(a){a.l.splice(a.l.indexOf(this),1)}),re.c("mouse").statics({l:[],press:function(a){var b,c;a.which==null?a.button<2?b="left":a.button==4?b="middle":b="right":a.which<2?b="left":a.which==2?b="middle":b="right",c="mouse:"+b,re.pressed.d&&(re.pressed.d[c]=a.type=="mousedown"),re.c("mouse").event(a,c)},event:function(a,b){var c,d;a.pageX?(c=a.pageX,d=a.pageY):(c=a.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,d=a.clientY+document.body.scrollTop+document.documentElement.scrollTop),c-=re.sys.canvas.offsetLeft,d-=re.sys.canvas.offsetTop;if(c<0||d<0||d>re.sys.sizeY||c>re.sys.sizeX)return;var e=re.c("mouse"),f,g,h;for(var i=0;i<e.l.length;i++)g=e.l[i],h={x:c,y:d},h.screenX=re.screen.toScreenX(c),h.screenY=re.screen.toScreenY(d),g.trigger(a.type,h,a),b&&g.trigger(a.type+":"+b,h,a)},i:function(){re.listener("mousedown",this.press,!1),re.listener("mouseup",this.press,!1),re.listener("mousemove",this.event,!1),re.listener("click",this.event,!1),re.listener("dblclick",this.event,!1),re.listener("contextmenu",this.event,!1)}}).init(function(a){a.l.push(this)}).dispose(function(a){a.l.splice(a.l.indexOf(this),1)}),re.pressed=function(a){var b=arguments;re.is(a,"array")&&(b=a);for(var c=0,d=b.length;c<d;c++)if(re.pressed.d[b[c]])return!0;return!1},re.pressed.d={},re.bisect=re.c("bisect").statics({biToX:function(a,b,c){return this.biToTileX(a,b,c)*c},biToY:function(a,b,c){return this.biToTileY(a,b,c)*c},biToTileX:function(a,b,c){return a%(b/c)|0},biToTileY:function(a,b,c){return a*c/(b-.1)|0},tileToBi:function(a,b,c,d){return a+b*(c/d)}}).defines({biToX:function(a){return re.bisect.biToX(a,this.bisect,this.sizeX)},biToY:function(a){return re.bisect.biToY(a,this.bisect,this.sizeY)},biToTileX:function(a){return re.bisect.biToTileX(a,this.bisect,this.sizeX)},biToTileY:function(a){return re.bisect.biToTileY(a,this.bisect,this.sizeY)},tileToBi:function(a,b){return re.bisect.tileToBi(a,b,this.bisect,this.sizeX)}}).defaults({bisect:1,sizeX:1,sizeY:1}),re.c("body").defines({hit:function(a,b,c,d){return re.is(a,"object")&&(b=a.posY,c=a.sizeX,d=a.sizeY,a=a.posX),!(a>this.posX+this.bodyX-this.padX||a+c<this.posX+this.padX||b>this.posY+this.bodyY-this.padY||b+d<this.posY+this.padY)},hitBody:function(a,b,c,d,e,f){return re.is(a,"object")&&(b=a.posY,c=a.bodyX,d=a.bodyY,e=a.padX,f=a.padY,a=a.posX),!(a+e>this.posX+this.bodyX+this.padX||a+c-e<this.posX+this.padX||b+f>this.posY+this.bodyY-this.padY||b+d-f<this.posY+this.padY)}}).defaults({posX:0,posY:0,padX:0,padY:0,bodyX:1,bodyY:1}),re.c("drag").defaults({posX:0,posY:0,dragX:0,dragY:0,dragging:!1}).defines({dragStart:function(a,b){return this.dragging||(this.dragging=!0,this.dragX=a,this.dragY=b,this.trigger("drag:start")),this},dragEnd:function(){return this.dragging=!1,this.trigger("drag:end")},dragUpdate:function(a,b){return this.dragging&&(this.posX+=a-this.dragX,this.posY+=b-this.dragY,this.dragX=a,this.dragY=b,this.trigger("drag:update")),this}}),re.force=re.c("force").requires("update").statics({graX:0,graY:0}).defaults({posX:0,posY:0,velX:0,velY:0,friX:.4,friY:.4,accX:0,accY:0,resX:.4,resY:.4,mass:1}).namespaces({update:function(){this.velX=this.force(this.velX,this.accX,this.friX,this.graX,this.mass),this.velY=this.force(this.velY,this.accY,this.friY,this.graY,this.mass),this.hitmap?this.aftermath(this.hitmap.checkHit(this)):this.aftermath(this.posX+this.velX,this.posY+this.velY)}}).defines({aftermath:function(a,b,c,d){return re.is(a,"object")&&(c=a.hitX,d=a.hitY,b=a.posY,a=a.posX),this.posX=a,this.posY=b,c&&(this.velX=this.forceRes(this.velX,this.resX)),d&&(this.velY=this.forceRes(this.velY,this.resY)),this.trigger("aftermath",c,d)},forceRes:function(a,b){return a*-b},forceGra:function(a,b){return a*b},forceVel:function(a,b,c){return(a+b)*c},force:function(a,b,c,d,e){var f=this.forceVel(a,b,c)+this.forceGra(d,e);return Math.abs(f)<.01&&(f=0),f},isIdle:function(){return!(this.velY+this.velX+this.accX+this.accY)}}).init(function(a){this.def({hitmap:re.hitmap,graX:a.graX,graY:a.graY}),this.on("update",this.force_update)}).dispose(function(){this.off("update",this.force_update)}),re.c("hit").defaults({posX:0,posY:0,sizeX:1,sizeY:1,hit:function(a,b,c,d){return re.is(a,"object")&&(b=a.posY||a.y,c=a.sizeX||a.w,d=a.sizeY||a.h,a=a.posX||a.x),!(a>this.posX+this.sizeX||a+c<this.posX||b>this.posY+this.sizeY||b+d<this.posY)}}),re.c("hitmap").requires("arraymap").defines({hitValue:1,checkAxisX:function(a,b,c,d,e){return a==this.hitValue},checkAxisY:function(a,b,c,d,e){return a==this.hitValue},checkHit:function(a,b,c,d,e,f,g,h){if(arguments.length==1){var c=a.velX,d=a.velY,e=a.bodyX,f=a.bodyY,g=a.padX,h=a.padY,b=a.posY;a=a.posX}var i={posX:a,posY:b,tarX:-1,tarY:-1},j=~~(Math.max(Math.abs(c),Math.abs(d))/((re.tile.sizeX+re.tile.sizeY)*.5)+.5);if(j>1){var k=c/j,l=d/j;for(var m=0;m<j&&(k||l);m++)this.hitmap_step(i,a,b,k,l,e,f,h,h),i.hitX&&(k=0),i.hitY&&(l=0)}else this.hitmap_step(i,a,b,c,d,e,f,g,h);return i}}).namespaces({step:function(a,b,c,d,e,f,g,h,i){a.posX+=d,a.posY+=e;var j,k,l;if(d){j=re.tile.sizeX;var m=d>0?f-h:h,n=Math.floor((c+i)/j),o=Math.ceil((c+g-i)/j);l=Math.floor((b+d+m)/j);var p=d<0?j:0;if(l>=0&&l<this.lengthX&&o>=0&&n<this.lengthY)for(k=n;k<o;k++)if(this.map[k]){this.trigger("hit",this.map[k][l],l,k);if(this.checkAxisX(this.map[k][l],b,c,d,e)){a.hitX=!0,a.posX=l*j+p-m,a.tarX=l*j,a.tarY=k*j;break}}}if(e){j=re.tile.sizeY;var q=e>0?g-i:i,r=Math.floor((a.posX+h)/j),s=Math.ceil((a.posX+f-h)/j);k=Math.floor((c+e+q)/j);var t=e<0?j:0;if(k>=0&&k<this.lengthY&&s>=0&&r<this.lengthX)for(l=r;l<s;l++)if(this.map[k]){this.trigger("hit",this.map[k][l],l,k);if(this.checkAxisY(this.map[k][l],b,c,d,e)){a.hitY=!0,a.posY=k*j+t-q,a.tarX=l*j,a.tarY=k*j;break}}}}}),re.c("limit").defines("limit",function(a){var b=arguments;return this[a]<b[1]?this[a]=b[1]:re.is(b[2])&&this[a]>b[2]&&(this[a]=b[2]),this}),re.c("point").defaults({posX:0,posY:0}).defines({pos:function(a,b){return re.is(a,"object")&&(b=a.posY||a.y,a=a.posX||a.x),this.posX=a,this.posY=b,this},distanceTo:function(a,b){re.is(a,"object")&&(b=a.posY||a.y,a=a.posX||a.x);var c,d;return c=a-this.posX,d=b-this.posY,Math.sqrt(c*c+d*d)+.5|0}}),re.tile=re.c("tile").statics({sizeX:40,sizeY:40,toX:function(a,b){return b=b||this.sizeX,this.toTileX(a,b)*b},toY:function(a,b){return b=b||this.sizeY,this.toTileY(a,b)*b},toTileX:function(a,b){return b=b||this.sizeX,(a-b*.5)/b+.5|0},toTileY:function(a,b){return b=b||this.sizeY,(a-b*.5)/b+.5|0}}).defaults({posX:0,posY:0}).init(function(){this.def({sizeX:re.tile.sizeX,sizeY:re.tile.sizeY})}).defines({tile:function(a,b){return re.is(a,"object")&&(b=a.posY||a.y,a=a.posX||a.x),this.tileX(a),this.tileY(b),this},tileX:function(a){return re.is(a)?(this.posX=a*this.sizeX,this):re.tile.toTileX(this.posX,this.sizeX)},tileY:function(a){return re.is(a)?(this.posY=a*this.sizeY,this):re.tile.toTileY(this.posY,this.sizeY)}}),re.c("playlist"),re.sound=re.c("sound").statics({enabled:!0}).defaults({playing:!1}).namespaces({e:!1,ended:function(){this.trigger("sound:end"),this.currentTime=0}}).defines({play:function(){if(!this._sound||!re.sound.enabled)return this;this.playing&&this.stop();var a=this._sound,b=this;a.currentTime=0;if(!this.sound_e){this.sound_e=!0;var c=function(){b.sound_ended(),a.removeEventListener("ended",c),b.sound_e=!1};a.addEventListener("ended",c,!1)}return a.play(),this},resume:function(){return this._sound.play(),this.playing=!0,this},pause:function(){return this._sound.pause(),this.playing=!1,this},currentTime:function(){return this._sound.currentTime},ended:function(){return this._sound.ended}}),re.c("socket").defines({connect:function(a){this.socket=new WebSocket(a)},close:function(){return this.socket?(this.socket.close(),this):this},open:function(a){if(!this.socket)return this;this.socket.onopen=a},error:function(a){if(!this.socket)return this;this.socket.onerror=a},message:function(a){if(!this.socket)return this;this.socket.onmessage=a},send:function(){if(!this.socket)return this;this.socket.send.apply(this.socket,arguments)}}),re.c("automap").defaults({lenX:0,lenY:0}).defines({value:0,automap:function(a,b,c){if(re.is(a,"array")){if(b)this.map=a,a.length>0?this.lenX=a[0].length:this.lenX=0,this.lenY=a.length;else for(var b=0;b<a.length;b++)for(var d=0;d<a[0].length;d++)this.automap(d,b,a[b][d]);return this}if(!re.is(c))return this.within(a,b)?this.map[b][a]:null;while(b>=this.map.length){var e=new Array(this.map[0]);for(var f in e)e[f]=this.value;this.map.push(e)}while(a>=this.map[this.map.length-1].length)for(var d=0;d<this.map.length;d++)this.map[d].push(this.value);return this.lenX=this.map[b].length,this.lenY=this.map.length,this.map[b][a]=c,this},within:function(a,b){return b<0||b>=this.lenY||a<0||a>=this.lenX?!1:!0},copy:function(a){return this},copyByRef:function(a){return this}}).init(function(){this.map=[]}),re.c("flicker").requires("update timestep").interfaces("flick").init(function(){this.flicker_reels={},this.flicker_old={},this.flicker_reel={},this.flicker_flickering=""}).defines({flicker_stop:function(){var a=this.flicker_flickering;return this.flicker_flickering="",this.stepProgress=0,this.off("update",this.flicker_update),this.trigger("flicker:end",a)},flicker_update:function(a){this.timestep(a,function(){var a=this.flicker_reel;if(this.flicker_frame==this.flicker_reel.frames.length){if(!(a.loops==-1||--this.flicker_loops>=1)){this.flicker_stop();return}this.flicker_frame=0}this.flick(a.frames[this.flicker_frame],this.flicker_flickering,this.flicker_loops)===!1&&this.flicker(),this.flicker_frame++})},addFlicker:function(a,b,c,d){if(re.is(a,"object")){for(var e in a){if(!a.hasOwnProperty(e))continue;var f=a[e].slice();f.unshift(e),this.addFlicker.apply(this,f)}return this}return re.is(d,"string")&&(d=d.split(" ")),this.flicker_reels[a]={frames:d,duration:c,loops:b},this},removeFlicker:function(a){if(re.is(a,"object")){for(var b in a){if(!a.hasOwnProperty(b))continue;this.removeFlicker.call(this,a[b])}return this}return delete this.flicker_reels[a],this},flicker:function(a,b,c,d){if(!re.is(a)&&this.flickering())return this.flicker_stop();if(a==this.flicker_flickering)return;if(!this.flicker_reels[a])return this;var e=this.flicker_reels[a],f=this.flicker_reel;return f.loops=isNaN(b)?e.loops:b,f.duration=isNaN(c)?e.duration:c,f.frames=re.is(d,"object")?d:e.frames,this.flicker_loops=f.loops,this.stepProgress=0,this.stepSize=f.duration/f.frames.length/1e3,this.flicker_frame=0,this.flick(f.frames[this.flicker_frame++]),this.flickering()||this.on("update",this.flicker_update),this.flicker_flickering=a,this.trigger("flicker:start")},flickering:function(a){return a?this.flicker_flickering==a:this.flicker_flickering}}),re.c("timestep").defaults({stepProgress:0,stepSize:100}).defines({timestep:function(a,b,c){this.stepProgress+=a;while(this.stepProgress>=this.stepSize)b.call(c?c:this),this.stepProgress-=this.stepSize}}),re.c("storage").init(function(a,b){this.storage=window[b+"Storage"]}).defines({length:function(){return this.storage.length},key:function(a){return this.storage.key(a)},item:function(a,b){return re.is(b)?(this.storage.setItem(a,JSON.stringify(b)),this):JSON.parse(this.storage.getItem(a))},removeItem:function(a){return this.storage.removeItem(a),this},clear:function(){return this.storage.clear(),this}}),re.log=function(){try{console.log.apply(console,arguments)}catch(a){try{opera.postError.apply(opera,arguments)}catch(a){alert(Array.prototype.join.call(arguments," "))}}},re.c("polyfill").defines({requestAnimationFrame:function(a,b){return requestAnimFrame(a,b)}}).run(function(){window.requestAnimFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}),re.random=function(a,b){var c=Math.random();switch(arguments.length){case 0:return c;case 1:return c*a;case 2:return c*(a-b+1)+b}},re.scene=function(a){var b=re.c("scene");return re.is(a)?(b._scenes[a]||re.e("scene:"+a),b._scenes[a]):b._scenes[re.scene.current]},re.c("scene").statics({_scenes:{}}).init(function(a,b){a._scenes[b]=this,this.sceneName=b}).dispose(function(a){delete a._scenes
[this.sceneName]}).defines({enter:function(a){return re.is(a,"function")||(re.scene.current&&re.scene().exit(a),re.scene.current=this.sceneName,this.scene_enter&&this.scene_enter.apply(this,arguments)),this.scene_enter=a,this},exit:function(a){return re.is(a,"function")||(re.scene.current="",re.is(this.scene_exit,"function")&&this.scene_exit.apply(this,arguments),this.scene_exit&&this.scene_exit.apply(this,arguments)),this.scene_exit=a,this}}),re.sheet=function(a,b,c,d){var e=c||re.tile.sizeX,f=d||re.tile.sizeY;re.is(b,"array")&&(b=b.join(" "));var g,h,i=[];for(var j in a)g=a[j][0]||0,h=a[j][1]||0,i.push(j),re.c(j).requires("sprite "+b).defines({frameX:g,frameY:h,sizeX:e,sizeY:f});return i},re.support=function(a){if(arguments.length>1){var b;for(var c=0;c<arguments.length;c++){b=arguments[c];if(re.support(b))return b}return!1}var d=a.split(" "),e=!0;for(var f in d)e=e&&!!re.support[d[f]];return e};var c=re.support;c.canvas=!!document.createElement("canvas").getContext,c.text=!!c.canvas&&typeof document.createElement("canvas").getContext("2d").fillText=="function";var ele=document.createElement("audio");try{if(c.audio=!!ele.canPlayType){c.ogg=ele.canPlayType('audio/ogg; codecs="vorbis"'),c.mp3=ele.canPlayType("audio/mpeg;"),c.wav=ele.canPlayType('audio/wav; codecs="1"'),c.aac=ele.canPlayType("audio/x-m4a;")||ele.canPlayType("audio/aac;");for(var i in c)if(c[i]=="no"||c[i]=="")c[i]=!1}}catch(e){}try{c.localstorage=!!localStorage.getItem}catch(e){c.localstorage=!1}c.worker=!!window.Worker,c.webgl=!!window.WebGLRenderingContext,c.touch="ontouchstart"in window,re.c("arrow").requires("update sprite keyboard arrow.png").defines({speed:10,sizeX:40,sizeY:40,update:function(){var a=this.speed;re.pressed("w","up")?(this.posY-=a,this.frame(0)):re.pressed("s","down")&&(this.posY+=a,this.frame(2)),re.pressed("a","left")?(this.posX-=a,this.frame(3)):re.pressed("d","right")&&(this.posX+=a,this.frame(1))}}).init(function(){this.posX=re.sys.sizeX*.5,this.posY=re.sys.sizeY*.5,this.on("update",this.update)}),re.ready(function(){re.sys.init(re.canvas).start(),re.scene("load").enter()}),re.c("controls").requires("keyboard").defines({addArrow:function(a){a=a||1,re.e("arrow",a)},removeArrow:function(){re("arrow").random().dispose()}}).init(function(){this.on({"keydown:space":function(){this.addArrow()},"keyup:r":function(){this.removeArrow()}})}),re.scene("home").enter(function(){console.log("entering home scene. . ."),re.controls=re.e("controls"),re.controls.addArrow()}).exit(function(){console.log("exiting home scene. . .")}),re.scene("load").enter(function(){re.load(re.assets).complete(function(){console.log("finished loading..."),re.scene("home").enter()}).error(function(a){console.log("Error loading asset: "+a)}).progress(function(a){console.log("Finished loading: "+a)})}).exit(function(){}),re.load.path="assets/",re.assets={images:["images/arrow.png"],sounds:[]};